server {
    listen 80;
    server_name localhost;
    root /var/www/html;
    index index.php index.html index.htm;
    
    # Port configuration for redirects
    port_in_redirect off;
    absolute_redirect off;

    # Logging
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # BCOE&M specific location
    location /bcoem {
        alias /var/www/html/bcoem;
        try_files $uri $uri/ @bcoem;

        location ~ \.php$ {
            fastcgi_pass php:9000;
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME $request_filename;
            include fastcgi_params;
            fastcgi_param SERVER_PORT 8080;
            fastcgi_param HTTP_HOST localhost:8080;
            fastcgi_buffer_size 128k;
            fastcgi_buffers 256 16k;
            fastcgi_busy_buffers_size 256k;
            fastcgi_temp_file_write_size 256k;
        }
    }
    
    # Rewrite handler for BCOE&M
    location @bcoem {
        rewrite ^/bcoem/(.*)$ /bcoem/index.php?$args last;
    }

    # Handle .htaccess rules for BCOE&M
    location ~ /bcoem/(.+)\.(jpg|jpeg|gif|css|png|js|ico|html|xml|txt)$ {
        alias /var/www/html/bcoem/$1.$2;
    }

    # Deny access to .htaccess files
    location ~ /\.ht {
        deny all;
    }

    # Deny access to certain directories
    location ~ /bcoem/(includes|site|sql|lib|admin/default_data)/ {
        deny all;
        return 403;
    }

    # Main PHP handler
    location ~ \.php$ {
        try_files $uri =404;
        fastcgi_pass php:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
        fastcgi_param SERVER_PORT 8080;
        fastcgi_param HTTP_HOST localhost:8080;
    }

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # File upload size
    client_max_body_size 64M;
}
